@model Varejo.ViewModels.ValidadeViewModel

@{
    ViewData["Title"] = "Nova Validade";
}

<h1>Cadastrar Validade</h1>

<form asp-action="Create" method="post">

    <div class="mb-3">
        <label>Data de Validade</label>
        <input asp-for="DataValidade" type="date" class="form-control" />
        <span asp-validation-for="DataValidade" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label>Em Estoque?</label>
        <select asp-for="EmEstoque" class="form-select">
            <option value="true">Sim</option>
            <option value="false">Não</option>
        </select>
    </div>

    <hr />
    <h3>Produto</h3>

    <!-- Busca -->
    <div class="mb-3">
        <input type="text" id="produtoSearch" class="form-control" placeholder="Buscar produto..." />
    </div>

    <!-- Resultados -->
    <div class="row" id="produtoCards"></div>

    <hr />

    <h4>Produto Selecionado</h4>
    <div id="produtoSelecionado" class="row"></div>

    <!-- Campo oculto para enviar o ID do produto -->
    <input type="hidden" asp-for="ProdutoId" />

    <div class="mt-3 d-flex justify-content-between w-100">
        <button class="btn btn-primary" type="submit">Salvar</button>
        <a asp-action="Index" class="btn btn-secondary">Voltar</a>
    </div>
</form>


@section Scripts {
    <script>
        const produtoSearch = document.getElementById('produtoSearch');
        const produtoCards = document.getElementById('produtoCards');
        const produtoSelecionado = document.getElementById('produtoSelecionado');

        let debounceTimer;

        produtoSearch.addEventListener('input', function () {
            clearTimeout(debounceTimer);

            debounceTimer = setTimeout(async () => {
                const termo = produtoSearch.value.trim();

                if (termo.length < 2) {
                    produtoCards.innerHTML = '';
                    return;
                }

                const url = '@Url.Action("SearchProduto", "Validade")?query=' + encodeURIComponent(termo);
                const response = await fetch(url);
                const produtos = await response.json();

                produtoCards.innerHTML = '';

                produtos.forEach(produto => {
                    const div = document.createElement('div');
                    div.classList.add('col-md-3', 'mb-3', 'produto-card');

                    const imagem = produto.UrlImagem || '/images/produto-padrao.png';

                    div.innerHTML = `
                        <div class="card movimento-card">
                            <img src="${imagem}" class="card-img-top"/>
                            <div class="card-body">
                                <h5 class="card-title">${produto.NomeProduto}</h5>
                                <button type="button" class="btn btn-success btn-sm mt-2 selectProdutoBtn">Selecionar</button>
                            </div>
                        </div>
                    `;

                    div.querySelector('.selectProdutoBtn').addEventListener('click', function () {
                        const selectedDiv = `
                            <div class="col-md-4">
                                <div class="card">
                                    <img src="${imagem}" class="card-img-top"/>
                                    <div class="card-body">
                                        <h5 class="card-title">${produto.NomeProduto}</h5>
                                    </div>
                                </div>
                            </div>
                        `;

                        produtoSelecionado.innerHTML = selectedDiv;

                        // preencher hidden field
                        document.getElementById('ProdutoId').value = produto.IdProduto;

                        produtoCards.innerHTML = '';
                        produtoSearch.value = '';
                    });

                    produtoCards.appendChild(div);
                });

            }, 300);
        });
    </script>
}
