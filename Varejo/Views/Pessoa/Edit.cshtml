@model Varejo.ViewModels.PessoaViewModel

@{
    ViewData["Title"] = "Editar Pessoa";
}

<h2>@ViewData["Title"]</h2>

<form asp-action="Edit" method="post">
    <input type="hidden" asp-for="IdPessoa" />

    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

    <div class="mb-3">
        <label asp-for="NomeRazao" class="form-label"></label>
        <input asp-for="NomeRazao" class="form-control" />
        <span asp-validation-for="NomeRazao" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="TratamentoFantasia" class="form-label"></label>
        <input asp-for="TratamentoFantasia" class="form-control" />
        <span asp-validation-for="TratamentoFantasia" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="CpfCnpj" class="form-label"></label>
        <input asp-for="CpfCnpj" id="CpfCnpj" class="form-control" />
        <span asp-validation-for="CpfCnpj" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Ddd" class="form-label"></label>
        <input asp-for="Ddd" class="form-control" />
        <span asp-validation-for="Ddd" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Telefone" class="form-label"></label>
        <input asp-for="Telefone" class="form-control" />
        <span asp-validation-for="Telefone" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Email" class="form-label"></label>
        <input asp-for="Email" class="form-control" />
        <span asp-validation-for="Email" class="text-danger"></span>
    </div>

    <div class="mb-3 d-flex justify-content-evenly flex-column flex-md-row">

        <label class="card check p-3 text-center mb-2">
            <input asp-for="EhJuridico" id="EhJuridico" class="form-check-input d-none" type="checkbox" />
            Jurídico
        </label>

        <label class="card check p-3 text-center mb-2">
            <input asp-for="EhUsuario" class="form-check-input d-none" type="checkbox" />
            Usuário
        </label>

        <label class="card check p-3 text-center mb-2">
            <input asp-for="EhCliente" class="form-check-input d-none" type="checkbox" />
            Cliente
        </label>

        <label class="card check p-3 text-center mb-2">
            <input asp-for="EhFornecedor" class="form-check-input d-none" type="checkbox" />
            Fornecedor
        </label>

        <label class="card check p-3 text-center ativo-btn mb-2">
            <input asp-for="Ativo" class="form-check-input d-none" type="checkbox" />
        </label>
    </div>



    <h4>Endereços</h4>
    <div id="enderecos-container">
        @for (int i = 0; i < Model.Enderecos.Count; i++)
        {
            <div class="endereco-item mb-3 border p-2">


                <label asp-for="Enderecos[i].Logradouro"></label>
                <input asp-for="Enderecos[i].Logradouro" class="form-control" />

                <label asp-for="Enderecos[i].Numero"></label>
                <input asp-for="Enderecos[i].Numero" class="form-control" />

                <label asp-for="Enderecos[i].Cep"></label>
                <input asp-for="Enderecos[i].Cep" class="form-control" />

                <label asp-for="Enderecos[i].Bairro"></label>
                <input asp-for="Enderecos[i].Bairro" class="form-control" />

                <label asp-for="Enderecos[i].Cidade"></label>
                <input asp-for="Enderecos[i].Cidade" class="form-control" />

                <label asp-for="Enderecos[i].Uf"></label>
                <input asp-for="Enderecos[i].Uf" class="form-control" />

                <label asp-for="Enderecos[i].Complemento"></label>
                <input asp-for="Enderecos[i].Complemento" class="form-control" />

                <button type="button" class="btn btn-danger mt-2 remover-endereco">Remover</button>
            </div>
        }
    </div>

    <button type="button" id="adicionar-endereco" class="btn btn-success mb-3">+ Adicionar Endereço</button>


    <div>
        <button type="submit" class="btn btn-primary">Salvar</button>
        <a asp-action="Index" class="btn btn-secondary">Voltar</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
            crossorigin="anonymous"></script>

    <script>
        function limpa_formulario_cep(container) {
            container.find("[name$='.Logradouro']").val('');
            container.find("[name$='.Bairro']").val('');
            container.find("[name$='.Cidade']").val('');
            container.find("[name$='.Uf']").val('');
        }

        function consulta_cep(inputCep) {
            var container = $(inputCep).closest('.endereco-item');
            var cep = $(inputCep).val().replace(/\D/g, '');

            if (cep !== '') {
                var validacep = /^[0-9]{8}$/;

                if (validacep.test(cep)) {
                    container.find("[name$='.Logradouro']").val('...');
                    container.find("[name$='.Bairro']").val('...');
                    container.find("[name$='.Cidade']").val('...');
                    container.find("[name$='.Uf']").val('...');

                    $.getJSON("https://viacep.com.br/ws/" + cep + "/json/?callback=?", function(dados) {
                        if (!("erro" in dados)) {
                            container.find("[name$='.Logradouro']").val(dados.logradouro);
                            container.find("[name$='.Bairro']").val(dados.bairro);
                            container.find("[name$='.Cidade']").val(dados.localidade);
                            container.find("[name$='.Uf']").val(dados.uf);
                        } else {
                            limpa_formulario_cep(container);
                            alert("CEP não encontrado.");
                        }
                    });
                } else {
                    limpa_formulario_cep(container);
                    alert("Formato de CEP inválido.");
                }
            } else {
                limpa_formulario_cep(container);
            }
        }

        $(document).ready(function() {
            // Vincula o evento para todos os CEPs existentes
            $(document).on('blur', "[name$='.Cep']", function() {
                consulta_cep(this);
            });

            // Adicionar endereço
            $('#adicionar-endereco').on('click', function() {
                var container = $('#enderecos-container');
                var index = container.children().length;
                var html = `
                <div class="endereco-item mb-3 border p-2">
                    <label for="Enderecos_${index}__Logradouro">Logradouro</label>
                    <input name="Enderecos[${index}].Logradouro" class="form-control" />

                    <label for="Enderecos_${index}__Numero">Número</label>
                    <input name="Enderecos[${index}].Numero" class="form-control" />

                    <label for="Enderecos_${index}__Cep">CEP</label>
                    <input name="Enderecos[${index}].Cep" class="form-control" />

                    <label for="Enderecos_${index}__Bairro">Bairro</label>
                    <input name="Enderecos[${index}].Bairro" class="form-control" />

                    <label for="Enderecos_${index}__Cidade">Cidade</label>
                    <input name="Enderecos[${index}].Cidade" class="form-control" />

                    <label for="Enderecos_${index}__Uf">UF</label>
                    <input name="Enderecos[${index}].Uf" class="form-control" />

                    <label for="Enderecos_${index}__Complemento">Complemento</label>
                    <input name="Enderecos[${index}].Complemento" class="form-control" />

                    <button type="button" class="btn btn-danger mt-2 remover-endereco">Remover</button>
                </div>`;
                container.append(html);
            });

            // Remover endereço
            $(document).on('click', '.remover-endereco', function() {
                $(this).closest('.endereco-item').remove();
            });
        });
    </script>
}

